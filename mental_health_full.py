import streamlit as st
from openai import OpenAI

# --- 1. åˆå§‹åŒ– Session State ---
if 'generated_prompt' not in st.session_state:
    st.session_state.generated_prompt = ""
if 'page' not in st.session_state:
    st.session_state.page = "æµ‹è¯„ä¸»é¡µ"

# --- 2. ã€å…¨é‡é¢˜åº“ã€‘ ---
SCL90_DATA = {
    "èº¯ä½“åŒ–": ["å¤´ç—›", "å¤´æ˜æˆ–å¤´é‡è„šè½»", "èƒ¸ç—›", "è…°ç—›", "æ¶å¿ƒæˆ–èƒƒéƒ¨ä¸èˆ’æœ", "è‚Œè‚‰é…¸ç—›", "å‘¼å¸å›°éš¾", "ä¸€é˜µé˜µå‘å†·æˆ–å‘çƒ­", "èº«ä½“æŸä¸€éƒ¨åˆ†éº»æœ¨æˆ–åˆºç—›", "å–‰å’™æœ‰æ¢—å¡æ„Ÿ", "æ„Ÿåˆ°èº«ä½“è™šå¼±æ— åŠ›", "æ„Ÿåˆ°æ‰‹è„šæ²‰é‡"],
    "å¼ºè¿«ç—‡çŠ¶": ["å¤´è„‘ä¸­æœ‰ä¸å¿…è¦çš„æƒ³æ³•æˆ–å­—å¥åå¤å‡ºç°", "å¿˜æ€§å¤§ï¼Œè®¸å¤šäº‹è½¬çœ¼å°±å¿˜", "æ‹…å¿ƒè‡ªå·±çš„è¡£ç€æ•´æ´åŠä»ªæ€ä¸ç«¯æ­£", "æ„Ÿåˆ°éš¾ä»¥å®Œæˆä»»åŠ¡", "åšäº‹å¿…é¡»åå¤æ£€æŸ¥", "éš¾ä»¥ä½œå‡ºå†³å®š", "è„‘å­å˜ç©ºäº†", "å¿…é¡»æ´—æ‰‹ã€è®¡æ•°æˆ–è§¦æ‘¸æŸäº›ä¸œè¥¿", "æ„Ÿåˆ°åšä»»ä½•äº‹æƒ…éƒ½å¾ˆå›°éš¾", "åå¤å‡ºç°æ´—æ‰‹çš„åŠ¨ä½œ"],
    "äººé™…æ•æ„Ÿ": ["å¯¹æ—äººå¹æ¯›æ±‚ç–µ", "æ„Ÿåˆ°å®¹æ˜“å—è´£å¤‡", "æ„Ÿåˆ°åˆ«äººä¸ç†è§£ä½ æˆ–ä¸åŒæƒ…ä½ ", "æ„Ÿåˆ°äººä»¬å¯¹ä½ å†·æ·¡", "åœ¨åˆ«äººçœ‹ç€ä½ æˆ–è°ˆè®ºä½ æ—¶æ„Ÿåˆ°ä¸è‡ªåœ¨", "æ„Ÿåˆ°è‡ªå‘", "æ„Ÿåˆ°ä¸åˆ«äººæ ¼æ ¼ä¸å…¥", "åœ¨ç¤¾äº¤åœºåˆæ„Ÿåˆ°ä¸è‡ªç„¶", "æ„Ÿåˆ°åˆ«äººåœ¨è§‚å¯Ÿä½ æˆ–è°ˆè®ºä½ "],
    "æŠ‘éƒ": ["æ„Ÿåˆ°ç²¾åŠ›ä¸‹é™ï¼Œæ´»åŠ¨å‡æ…¢", "æƒ³è‡ªæ€", "å®¹æ˜“å“­æ³£", "ç»å¸¸è´£å¤‡è‡ªå·±", "æ„Ÿåˆ°å­¤ç‹¬", "æ„Ÿåˆ°è‹¦é—·", "è¿‡åˆ†æ‹…å¿§", "å¯¹äº‹ç‰©ä¸æ„Ÿå…´è¶£", "æ„Ÿåˆ°å‰é€”æ²¡æœ‰å¸Œæœ›", "æ„Ÿåˆ°ä»»ä½•äº‹æƒ…éƒ½å¾ˆå›°éš¾", "æ„Ÿåˆ°å¿§éƒ", "å¯¹ç”Ÿæ´»å¤±å»å…´è¶£", "æ„Ÿåˆ°è‡ªå·±æ²¡ç”¨"],
    "ç„¦è™‘": ["ç¥ç»è¿‡æ•ï¼Œå¿ƒä¸­ä¸è¸å®", "æ— ç¼˜æ— æ•…åœ°çªç„¶æ„Ÿåˆ°å®³æ€•", "å®¹æ˜“çƒ¦æ¼å’Œæ¿€åŠ¨", "æ„Ÿåˆ°å®³æ€•", "å¿ƒè·³å¾—å¾ˆå‰å®³", "æ„Ÿåˆ°ç´§å¼ æˆ–å®¹æ˜“ç´§å¼ ", "æ„Ÿåˆ°åç«‹ä¸å®‰", "è§‰å¾—æœ‰ä»€ä¹ˆå¯æ€•çš„äº‹è¦å‘ç”Ÿ", "æ„Ÿåˆ°ææƒ§", "å¿ƒç¥ä¸å®šï¼Œæ„Ÿåˆ°ç”±äºææƒ§è€Œå¤±å»äº†å¹³è¡¡"],
    "æ•Œå¯¹": ["å®¹æ˜“çƒ¦æ¼å’Œæ¿€åŠ¨", "æœ‰æ§åˆ¶ä¸ä½çš„æ„¤æ¨çˆ†å‘", "æœ‰æ‰“äººæˆ–ä¼¤å®³ä»–äººçš„å†²åŠ¨", "æœ‰æ‘”åä¸œè¥¿çš„æ„¿æœ›", "å®¹æ˜“ä¸äººäº‰åµ", "æ„Ÿåˆ°ä¸å¯æŠ‘åˆ¶åœ°å¤§å£°å«å–Š"],
    "ææ€–": ["å®³æ€•åœ¨å¤§ç©ºåœºæˆ–è¡—é“ä¸Š", "å®³æ€•å‡ºé—¨", "å®³æ€•ä¹˜è½¦ã€åœ°é“æˆ–ç”µæ¢¯", "å› ææƒ§è€Œå›é¿æŸäº›äº‹ç‰©", "åœ¨äººç¾¤ä¸­æ„Ÿåˆ°ä¸å®‰", "æ„Ÿåˆ°åœ¨å…¬å…±åœºåˆåƒä¸œè¥¿ä¸è‡ªç„¶"],
    "åæ‰§": ["è§‰å¾—åˆ«äººåœ¨æ§åˆ¶ä½ çš„æ€æƒ³", "è§‰å¾—åˆ«äººçŸ¥é“ä½ ç§ä¸‹çš„æƒ³æ³•", "è§‰å¾—åˆ«äººåœ¨èƒŒåè®®è®ºä½ ", "è§‰å¾—åˆ«äººä¸å€¼å¾—ä¿¡ä»»", "è§‰å¾—åˆ«äººåœ¨ç›¯ç€ä½ ", "æ„Ÿåˆ°åˆ«äººåœ¨çœ‹ä¸èµ·ä½ "],
    "ç²¾ç¥ç—…æ€§": ["å¬åˆ°åˆ«äººå¬ä¸åˆ°çš„å£°éŸ³", "è§‰å¾—åˆ«äººèƒ½è¯†ç ´ä½ çš„éšç§", "æ„Ÿåˆ°åˆ«äººåœ¨ç›‘è§†ä½ ", "è®¤ä¸ºä½ çš„èº«ä½“æœ‰ä¸¥é‡é—®é¢˜", "ä»æœªæœ‰è¿‡çš„å¥‡æ€ªæƒ³æ³•", "æ„Ÿåˆ°å­¤ç‹¬ï¼ˆå³ä½¿å’Œåˆ«äººåœ¨ä¸€èµ·æ—¶ï¼‰"],
    "å…¶ä»–": ["å…¥ç¡å›°éš¾", "é†’å¾—å¤ªæ—©", "ç¡çœ ä¸æ·±", "èƒƒå£ä¸å¥½", "å¤šæ¢¦"]
}

EPQ_DATA = {
    "Eï¼ˆå†…å¤–å‘ï¼‰": ["ä½ æ˜¯å¦å–œæ¬¢çƒ­é—¹çš„èšä¼šï¼Ÿ", "å½“ä½ ä¸äººäº¤å¾€æ—¶ï¼Œä½ æ˜¯å¦é€šå¸¸æ˜¯å…ˆå¼€å£è¯´è¯çš„äººï¼Ÿ", "ä½ æ˜¯å¦å–œæ¬¢é‚£ç§éœ€è¦å¿«é€Ÿåšå‡ºååº”çš„äº‹æƒ…ï¼Ÿ", "ä½ æ˜¯å¦è§‰å¾—è‡ªå·±æ˜¯ä¸€ä¸ªå¥è°ˆçš„äººï¼Ÿ", "ä½ æ˜¯å¦å–œæ¬¢ç¤¾äº¤æ´»åŠ¨ï¼Ÿ", "ä½ æ˜¯å¦é€šå¸¸æ˜¯ä¸€ä¸ªæ— å¿§æ— è™‘çš„äººï¼Ÿ"],
    "Nï¼ˆç¥ç»è´¨ï¼‰": ["ä½ çš„å¿ƒæƒ…æ˜¯å¦ç»å¸¸èµ·ä¼ä¸å®šï¼Ÿ", "ä½ æ˜¯å¦å®¹æ˜“ä¸ºäº†æŸäº›äº‹è€Œæ„Ÿåˆ°çƒ¦æ¼ï¼Ÿ", "ä½ æ˜¯å¦ç»å¸¸è§‰å¾—â€˜å¿ƒçƒ¦æ„ä¹±â€™ï¼Ÿ", "ä½ æ˜¯å¦å®¹æ˜“è§‰å¾—å—åˆ°ä¼¤å®³ï¼Ÿ", "ä½ æ˜¯å¦ç»å¸¸æ„Ÿåˆ°è‡ªå·±å¾ˆå­¤ç‹¬ï¼Ÿ", "ä½ æ˜¯å¦å®¹æ˜“æ„Ÿåˆ°ç´§å¼ å’Œç´§è¿«ï¼Ÿ"],
    "Pï¼ˆç²¾ç¥è´¨ï¼‰": ["ä½ æ˜¯å¦å€¾å‘äºä¸å…³å¿ƒä»–äººï¼Ÿ", "ä½ æ˜¯å¦å–œæ¬¢æŒ‰ç…§è‡ªå·±çš„æ–¹å¼åšäº‹ï¼Ÿ", "ä½ æ˜¯å¦è§‰å¾—åŒæƒ…å¿ƒæ˜¯å¤šä½™çš„ï¼Ÿ", "ä½ æ˜¯å¦å®¹æ˜“å˜å¾—å†·æ·¡ï¼Ÿ"],
    "Lï¼ˆæ©é¥°æ€§ï¼‰": ["ä½ æ˜¯å¦æ‰€æœ‰çš„ä¹ æƒ¯éƒ½æ˜¯å¥½çš„ï¼Ÿ", "ä½ æ˜¯å¦ä»æœªè¯´è¿‡è°ï¼Ÿ", "ä½ æ˜¯å¦æ€»æ˜¯å‡†æ—¶ï¼Ÿ"]
}

BDI_DATA = { "æ ¸å¿ƒç»´åº¦": ["1. æ‚²ä¼¤", "2. ä¹è§‚ç¨‹åº¦", "3. è¿‡å»å¤±è´¥æ„Ÿ", "4. æ»¡è¶³æ„Ÿ", "5. ç½ªæ¶æ„Ÿ", "6. å—æƒ©ç½šæ„Ÿ", "7. è‡ªæˆ‘åŒæ¶", "8. è‡ªæˆ‘æŒ‡è´£", "9. è‡ªæ€æ„å‘", "10. å“­æ³£é¢‘ç‡", "11. æ¿€æƒ¹æ€§", "12. ç¤¾äº¤é€€ç¼©", "13. çŠ¹è±«ä¸å†³", "14. ä½“è±¡æ”¹å˜", "15. å·¥ä½œå›°éš¾", "16. ç¡çœ éšœç¢", "17. ç–²åŠ³æ„Ÿ", "18. é£Ÿæ¬²å‡é€€", "19. ä½“é‡å‡è½»", "20. èº¯ä½“å…³æ³¨", "21. æ€§æ¬²å‡é€€"] }
GAD_DATA = { "æ ¸å¿ƒç»´åº¦": ["1. æ„Ÿåˆ°ç´§å¼ ã€ç„¦è™‘æˆ–æ€¥èº", "2. ä¸èƒ½åœæ­¢æˆ–æ§åˆ¶æ‹…å¿§", "3. å¯¹å„ç§å„æ ·çš„äº‹æƒ…æ‹…å¿§è¿‡å¤š", "4. å¾ˆéš¾æ”¾æ¾ä¸‹æ¥", "5. ç”±äºä¸å®‰è€Œæ— æ³•é™å", "6. å®¹æ˜“çƒ¦æ¼æˆ–æ€¥èº", "7. æ„Ÿåˆ°å¥½åƒæœ‰ä»€ä¹ˆå¯æ€•çš„äº‹ä¼šå‘ç”Ÿ"] }

# --- 3. æ ¸å¿ƒ API è°ƒç”¨ï¼ˆå¿ƒè¡€æŒ‡ä»¤å…¨æ–‡æ³¨å…¥ï¼‰ ---

def call_expert_ai(report_data, user_text):
    # ä½ çš„ API Key ä¿æŒä¸å˜
    client = OpenAI(api_key="sk-287bff28f6d249619192a72a39863809", base_url="https://api.deepseek.com")
    
    # [æ­¤å¤„å…¨æ–‡ä¿ç•™ä½ æä¾›çš„ä¸“ä¸šæç¤ºè¯]
    system_instruction = """ä½ æ˜¯ä¸€ä½èµ„æ·±ä¸´åºŠå¿ƒç†å­¦å®¶ï¼Œæ“…é•¿å¿ƒç†æµ‹é‡è¯„ä¼°ã€äººæ ¼åˆ†æå’Œå¿ƒç†é—®é¢˜æ¨æ–­ã€‚ä½ çš„ä»»åŠ¡æ˜¯åŸºäºç”¨æˆ·æä¾›çš„æ ‡å‡†åŒ–å¿ƒç†é—®å·æ•°æ®åŠè‡ªæˆ‘æè¿°æ–‡æœ¬ï¼Œç”Ÿæˆä¸€ä»½ â€œç”¨æˆ·å¿ƒç†ä¾§å†™æç¤ºè¯â€ã€‚è¯¥æç¤ºè¯å°†ä½œä¸ºåç»­ä¸ªæ€§åŒ–æœåŠ¡ï¼ˆå¦‚å¿ƒç†å’¨è¯¢ã€AIå¯¹è¯ç­‰ï¼‰çš„æ ¸å¿ƒè¾“å…¥ï¼Œå› æ­¤å¿…é¡»ä¸“ä¸šã€ç»†è‡´ã€å®¢è§‚ã€å…·æœ‰å¯æ“ä½œæ€§ã€‚

---

## ğŸ“‹ è¾“å…¥æ•°æ®æ ¼å¼
æ³¨æ„ï¼šæœ¬ç³»ç»Ÿé‡‡ç”¨ 0â€“10 åˆ†è¯„åˆ†åˆ¶ã€‚
### 1. BDIï¼ˆè´å…‹æŠ‘éƒé‡è¡¨ï¼‰ï¼š0â€“2.5æ— , 2.6â€“5.0è½», 5.1â€“7.5ä¸­, 7.6â€“10é‡ã€‚
### 2. GAD-7ï¼ˆç„¦è™‘é‡è¡¨ï¼‰ï¼š0â€“2.5æ— , 2.6â€“5.0è½», 5.1â€“7.5ä¸­, 7.6â€“10é‡ã€‚
### 3. SCL-90ï¼ˆç—‡çŠ¶è‡ªè¯„ï¼‰ï¼š0-2æ— , 2.1-4è½», 4.1-6ä¸­, 6.1-8æ˜æ˜¾, 8.1-10ä¸¥é‡ã€‚é˜³æ€§åˆ¤å®šï¼šâ‰¥2å¯èƒ½, â‰¥4ä¸­åº¦, â‰¥6æ˜æ˜¾, â‰¥8ä¸¥é‡ã€‚
### 4. è‰¾æ£®å…‹äººæ ¼é—®å·ï¼ˆEPQï¼‰ï¼šE(å†…å¤–å‘), N(ç¥ç»è´¨), P(ç²¾ç¥è´¨), L(æ©é¥°æ€§)ã€‚0-3, 4-6, 7-10 ä¸‰æ®µå¼è§£è¯»ã€‚
### 5. ç”¨æˆ·è‡ªä¸»æè¿°

---

## ğŸ¯ è¾“å‡ºè¦æ±‚
ç”Ÿæˆä¸­æ–‡æŠ¥å‘Šï¼ˆ800ï½1500å­—ï¼‰ï¼ŒåŒ…å«ï¼š
ä¸€ã€æ‘˜è¦ï¼ˆ200å­—ä»¥å†…ï¼‰
äºŒã€é‡è¡¨æ•°æ®åˆ†æ
ä¸‰ã€æ€§æ ¼ä¾§å†™å»ºæ¨¡
å››ã€å¿ƒç†é—®é¢˜æ¨æ–­ï¼ˆå¿…é¡»æ ‡æ³¨ï¼šéä¸´åºŠè¯Šæ–­ï¼‰
äº”ã€ç®€è¦å»ºè®®

---

## âš ï¸ æ³¨æ„äº‹é¡¹
1. é¿å…æ ‡ç­¾åŒ–ã€‚ 2. æ•°æ®é©±åŠ¨ã€‚ 3. è¯­æ°”æŠŠæ§ã€‚ 4. æ ¼å¼æ•´æ´ã€‚"""

    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=[
            {"role": "system", "content": system_instruction},
            {"role": "user", "content": f"ã€é‡è¡¨æ•°æ®æ±‡æ€»ã€‘:\n{report_data}\n\nã€ç”¨æˆ·è‡ªè¿°ã€‘:\n{user_text}"}
        ],
        temperature=0.4
    )
    return response.choices[0].message.content

# --- 4. æµ‹è¯„ç•Œé¢é€»è¾‘ ---

def show_main():
    st.set_page_config(page_title="ä¸“å®¶çº§ä¾§å†™ç³»ç»Ÿ", layout="wide")
    
    # --- å³ä¸Šè§’ä½¿ç”¨æ–‡æ¡£ ---
    with st.sidebar:
        st.title("ğŸ“– ä½¿ç”¨è¯´æ˜æ–‡æ¡£")
        st.info("""
        **æœ¬ç«™æ ¸å¿ƒç”¨é€”ï¼š**
        æœ¬ç«™ç”Ÿæˆçš„æŠ¥å‘Šæ˜¯**æ·±åº¦æç¤ºè¯ï¼ˆPromptï¼‰**ã€‚
        æ‚¨å¯ä»¥å°†å…¶å®Œæ•´**å¤åˆ¶å¹¶ç²˜è´´**è¿›å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚ï¼š**è±†åŒ…ã€DeepSeekã€ChatGPT**ï¼‰ä¸­ï¼Œä½œä¸ºè¾…åŠ©æé—®èƒŒæ™¯ï¼Œè®© AI èƒ½å¤ŸåŸºäºæ‚¨çš„çœŸå®æ•°æ®æä¾›ç²¾å‡†å’¨è¯¢ã€‚
        """)
        
        st.markdown("### ğŸ’¡ æµ‹è¯„é€‰æ‹©å»ºè®®ï¼š")
        st.warning("**å¦‚æœæ‚¨è®¤ä¸ºè‡ªå·±æœ‰å›°æ‰°ï¼Œä½†ä¸ç¡®å®šé—®é¢˜åœ¨å“ªé‡Œï¼š**")
        st.write("ğŸ‘‰ å»ºè®®å®Œæˆï¼š**å¿ƒç†æµ‹è¯• (SCL-90)**ã€**æŠ‘éƒæµ‹è¯• (BDI)**ã€**ç„¦è™‘æµ‹è¯• (GAD)**ã€‚è¿™èƒ½å¸®åŠ© AI é”å®šç—‡çŠ¶ã€‚")
        
        st.success("**å¦‚æœæ‚¨è®¤ä¸ºè‡ªå·±æ²¡æœ‰å¿ƒç†é—®é¢˜ï¼Œåªæ˜¯æƒ³æ›´äº†è§£è‡ªå·±ï¼š**")
        st.write("ğŸ‘‰ å»ºè®®å®Œæˆï¼š**æ€§æ ¼æµ‹è¯• (EPQ)**ã€‚è¿™èƒ½å¸®åŠ© AI åˆ†ææ‚¨çš„å¤©ç”Ÿæ°”è´¨ã€‚")
        
        st.divider()
        st.caption("æ³¨ï¼šæ‰€æœ‰æ•°æ®å‡ä»…ç”¨äºæœ¬åœ°ç”Ÿæˆ Promptï¼Œä¸ä¼šç•™å­˜ã€‚")

    st.title("ğŸ›¡ï¸ ä¸“å®¶çº§å¿ƒç†æµ‹è¯„ä¸ä¾§å†™ç³»ç»Ÿ")
    
    t1, t2, t3, t4 = st.tabs(["å¿ƒç†æµ‹è¯• (SCL-90)", "æ€§æ ¼æµ‹è¯• (EPQ)", "æŠ‘éƒæµ‹è¯• (BDI)", "ç„¦è™‘æµ‹è¯• (GAD)"])
    all_scores = {}

    def render_quiz(data, prefix, tab_obj):
        with tab_obj:
            sub_tabs = st.tabs(list(data.keys()))
            for i, (cat, qs) in enumerate(data.items()):
                with sub_tabs[i]:
                    for q in qs:
                        key = f"{prefix}_{cat}_{q}"
                        all_scores[key] = st.select_slider(q, options=list(range(11)), value=0, key=key)

    render_quiz(SCL90_DATA, "SCL", t1)
    render_quiz(EPQ_DATA, "EPQ", t2)
    render_quiz(BDI_DATA, "BDI", t3)
    render_quiz(GAD_DATA, "GAD", t4)

    st.markdown("---")
    user_input = st.text_area("âœï¸ ç”¨æˆ·è‡ªä¸»æè¿°æ–‡æœ¬ï¼š", placeholder="è¯·è¯¦ç»†è¾“å…¥ä½ çš„å›°æ‰°ã€èƒŒæ™¯ï¼Œä»¥ä¾¿ AI æ„å»ºæ›´ç«‹ä½“çš„ç”»åƒ...", height=200)

    if st.button("ğŸš€ æäº¤å¹¶ç”Ÿæˆä¾§å†™ Prompt"):
        final_summary = []
        for p, n in [("SCL", "SCL-90"), ("EPQ", "EPQ"), ("BDI", "BDI"), ("GAD", "GAD-7")]:
            scores = [v for k, v in all_scores.items() if k.startswith(p)]
            if any(s > 0 for s in scores):
                avg = round(sum(scores)/len(scores), 2)
                final_summary.append(f"- {n} å‡åˆ†: {avg}/10")

        if not final_summary:
            st.warning("è¯·è‡³å°‘å®Œæˆä¸€é¡¹æµ‹è¯„ã€‚")
        else:
            with st.spinner("èµ„æ·±å¿ƒç†å­¦å®¶æ­£åœ¨å®¡é˜…æ•°æ®å¹¶æ’°å†™æŠ¥å‘Š..."):
                report = call_expert_ai("\n".join(final_summary), user_input)
                st.session_state.generated_prompt = report
                st.session_state.page = "ç»“æœé¡µ"
                st.rerun()

# --- 5. ç»“æœé¡µ ---
def show_result():
    st.title("ğŸ“‹ æ·±åº¦å¿ƒç†ä¾§å†™æŠ¥å‘Š (æç¤ºè¯å·²å°±ç»ª)")
    st.code(st.session_state.generated_prompt, language="markdown")
    st.info("â¬†ï¸ ç‚¹å‡»å³ä¸Šè§’å¤åˆ¶ï¼Œç²˜è´´è‡³è±†åŒ…/DeepSeek ç­‰å¤§æ¨¡å‹ä¸­ä½¿ç”¨ã€‚")
    if st.button("â¬…ï¸ è¿”å›ä¿®æ”¹æ•°æ®"):
        st.session_state.page = "æµ‹è¯„ä¸»é¡µ"
        st.rerun()

if st.session_state.page == "æµ‹è¯„ä¸»é¡µ":
    show_main()
else:
    show_result()
